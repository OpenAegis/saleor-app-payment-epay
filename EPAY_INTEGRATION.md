# 彩虹易支付集成指南

## 概述

本文档详细说明了如何在 Saleor 电商平台中集成和使用彩虹易支付功能。彩虹易支付是一个流行的第三方支付平台，支持多种支付方式，包括支付宝、微信支付、QQ 钱包等，并且支持通过插件扩展更多支付方式。

## 配置要求

### 彩虹易支付商户账户

在开始集成之前，您需要拥有一个彩虹易支付商户账户。如果您还没有账户，请联系您的彩虹易支付服务提供商注册并完成商户认证。

### 获取商户信息

登录彩虹易支付商户后台后，您需要获取以下信息：

1. **商户 ID (PID)** - 在商户后台的 API 信息页面获取
2. **商户密钥 (Key)** - 在商户后台的 API 信息页面获取
3. **API 地址** - 您的彩虹易支付服务提供商提供的 API 地址

## 安装和配置

### 配置方式说明

本插件只支持后台管理界面配置方式：

#### 后台管理界面配置（唯一方式）

通过插件后台界面进行配置，支持多商户和动态配置：

- 登录插件管理后台 `/admin/login`
- 进入支付配置页面
- 填写商户信息并保存

### 后台管理界面配置步骤

1. 部署应用
2. 访问管理后台 `/admin/login`
3. 进入 "支付配置" 页面
4. 填写商户信息：
   - 配置名称：为这个支付配置设置一个易于识别的名称
   - 商户 ID：在彩虹易支付商户后台获取的 PID
   - 商户密钥：在彩虹易支付商户后台获取的 Key
   - API 地址：您的彩虹易支付服务提供商提供的 API 地址
   - 返回地址：支付完成后跳转的页面地址（可选，默认使用应用 URL）
5. 点击 "测试连接" 验证配置是否正确
6. 启用配置并保存

## 管理员配置

### 登录管理后台

访问 `/admin/login` 页面，使用在环境变量中配置的管理员凭据登录。

### 站点审批

新安装的 Saleor 站点需要管理员审批后才能使用支付功能：

1. 进入 "站点管理" 页面
2. 查看待审批的站点请求
3. 点击 "批准" 按钮批准站点

### 支付配置

1. 进入 "支付配置" 页面
2. 填写商户信息：
   - 配置名称：为这个支付配置设置一个易于识别的名称
   - 商户 ID：在彩虹易支付商户后台获取的 PID
   - 商户密钥：在彩虹易支付商户后台获取的 Key
   - API 地址：您的彩虹易支付服务提供商提供的 API 地址
   - 返回地址：支付完成后跳转的页面地址（可选）
3. 点击 "测试连接" 验证配置是否正确
4. 启用配置并保存

## 支付流程

### 1. 初始化支付

当客户在结账页面选择支付方式时，Saleor 会调用 `TRANSACTION_INITIALIZE_SESSION` webhook：

1. 应用接收支付请求
2. 从 Saleor metadata 中获取商户配置
3. 使用配置的商户信息创建彩虹易支付订单
4. 返回支付链接或二维码给客户

### 2. 客户支付

客户通过以下方式完成支付：

- 点击支付链接跳转到支付页面
- 扫描二维码完成支付

### 3. 支付回调

支付完成后，彩虹易支付会发送异步通知到 `/api/webhooks/epay-notify`：

1. 应用验证通知签名
2. 更新 Saleor 订单状态
3. 发送确认信息给客户

### 4. 状态查询

在需要时，应用可以通过 `TRANSACTION_PROCESS_SESSION` webhook 查询订单状态。

## 支持的支付方式

当前集成支持自定义支付方式，您可以根据在易支付平台配置的插件来设置支付类型：

- **支付宝** (alipay)
- **微信支付** (wxpay)
- **QQ 钱包** (qqpay)
- **银行卡支付** (bank)
- **其他自定义支付方式** - 根据易支付插件配置

支付方式通过 `paytype` 参数传递给易支付 API，支持任何在易支付平台配置的有效支付类型。

## 安全特性

### 签名验证

所有与彩虹易支付的通信都使用 MD5 签名算法进行安全验证：

1. 请求发送前生成签名
2. 接收响应后验证签名
3. 回调通知时验证签名

### 数据加密

敏感信息如商户密钥在存储时进行加密处理。

## 故障排除

### 常见问题

#### 1. 支付配置测试失败

- 检查商户 ID 和密钥是否正确
- 确认 API 地址格式正确
- 验证网络连接是否正常

#### 2. 支付回调未处理

- 检查回调 URL 是否正确配置在彩虹易支付后台
- 确认服务器防火墙允许外部访问
- 查看应用日志获取错误信息

#### 3. 订单状态未更新

- 检查 Saleor GraphQL API 连接
- 验证应用权限配置
- 查看异步任务执行情况

### 日志查看

应用日志可以帮助诊断问题：

```bash
# 查看应用日志
pnpm logs

# 或者在开发环境中查看控制台输出
```

## API 参考

### Webhook 端点

#### TRANSACTION_INITIALIZE_SESSION

- **URL**: `/api/webhooks/transaction-initialize`
- **方法**: POST
- **功能**: 初始化支付交易，创建彩虹易支付订单

#### TRANSACTION_PROCESS_SESSION

- **URL**: `/api/webhooks/transaction-process`
- **方法**: POST
- **功能**: 查询订单状态

#### 彩虹易支付回调

- **URL**: `/api/webhooks/epay-notify`
- **方法**: POST
- **功能**: 处理支付成功回调

### 配置管理 API

#### 获取配置

- **URL**: `/api/epay-config`
- **方法**: GET
- **功能**: 获取当前支付配置

#### 保存配置

- **URL**: `/api/epay-config`
- **方法**: POST
- **功能**: 保存支付配置

#### 测试配置

- **URL**: `/api/epay-config?test=true`
- **方法**: POST
- **功能**: 测试支付配置连接

## 最佳实践

### 1. 安全建议

- 定期更换商户密钥
- 使用 HTTPS 保护数据传输
- 限制管理后台访问 IP

### 2. 性能优化

- 启用应用缓存
- 优化数据库查询
- 使用 CDN 加速静态资源

### 3. 监控和维护

- 定期检查支付成功率
- 监控应用性能指标
- 及时处理支付异常

## 技术支持

如遇到技术问题，请联系您的彩虹易支付服务提供商或插件技术支持团队。

## 更新日志

### v1.0.0

- 初始版本发布
- 支持基本的彩虹易支付集成功能
- 实现支付创建、回调处理和状态查询
- 支持自定义支付方式（paytype）
- 只支持后台管理界面配置方式
- 支持从数据库配置中获取返回地址
